<%- include('../includes/head.ejs') %>
<%- include('../includes/navigation.ejs') %>
    	</head>
    	<body>
<%- include('../includes/gridTop.ejs') %>
		<div>
			<h1>Welcome to the CARS page</h1>
			<form action="/admin/<% if (editing && !errorMessage) { %>edit-car/<%=car._id%><% } %>"  method="POST" class="col-xs-8 col-sm-6 col-md-5">
                             	<div class="form-group">
                                    	<label for="serie">Serie:</label>
					<input type="text" name="serie" id="serie" class="form-control" value="<% if (editing) { %><%=car.serie%><% } %>" />
				</div>
                                <div class="form-group">
                                  	<label for="serieDetails">Serie details:</label>
                                       	<input type="text" name="serieDetails" id="serieDetails" class="form-control" value="<% if (editing) { %><%=car.serieDetails%><% } %>" />
                                </div>
                                <div class="form-group">
                                       	<label for="wheel">Wheel:</label>
					<input type="number" name="wheel" id="wheel" class="form-control" value="<% if (editing) { %><%=car.wheel%><% } %>" /> 
                               	</div>
				<div class="form-group">
                                       	<label for="engine">Engine:</label>
					<input type="text" name="engine" id="engine" class="form-control" value="<% if (editing) { %><%=car.engine%><% } %>" /> 
				</div>
 				<div class="form-group">
                                       	<label for="grade">Grade:</label>
					<input type="text" name="grade" id="grade" class="form-control" value="<% if (editing) { %><%=car.grade%><% } %>" /> 
				</div>
 				<div class="form-group">
                                       	<label for="price">Price:</label>
					<input type="text" name="price" id="price" class="form-control" value="<% if (editing) { %><%=car.price%><% } %>" /> 
				</div>
			<div class="form-group">
                                       	<label for="color">Color:</label>
					<input type="text" name="color" id="color" class="form-control" value="<% if (editing) { %><%=car.color%><% } %>" />
			</div>
 			<div class="form-group">
                                       	<label for="details">Details:</label>
                                       	<textarea name="details" id="details" class="form-control" row="5"><% if (editing) { %><%=car.details%><% } %></textarea>
                        </div>

 		<% if (editing) { %> 
 			<div class="form-group">
                                    	<label for="style">Style:</label>
                                    	<select name="style" id="style" class="form-control" />
		<option <%= car.style === 'Pick-up' ? 'selected' : '' %>>Pick-up</option>
		<option <%= car.style === 'Sedan' ? 'selected' : '' %>>Sedan</option>
		<option <%= car.style === 'Suv' ? 'selected' : '' %>>Suv</option>
		<option <%= car.style === 'Smart' ? 'selected' : '' %>>Smart</option>
		<option <%= car.style === 'Double' ? 'selected' : '' %>>Double</option>
		<option <%= car.style === 'Standart' ? 'selected' : '' %>>Standart</option>
					</select>
                       	</div>
			<div class="form-group">
                                    	<label for="type">Type:</label>
                                    	<select name="type" id="type" class="form-control" />
		<option <%= car.type === 'รุนรถ' ? 'selected' : '' %>>รุนรถ</option>
		<option <%= car.type === 'รถยนฅ์นั่งส่วนบุคคล' ? 'selected' : '' %>>รถยนฅ์นั่งส่วนบุคคล</option>
		<option <%= car.type === 'รถยนฅ์เพื่อการพาณิซย์' ? 'selected' : '' %>>รถยนฅ์เพื่อการพาณิซย์</option>
		<option <%= car.type === 'รถยนฅ์อเนกประสงค์' ? 'selected' : '' %>>รถยนฅ์อเนกประสงค์</option>
					</select>
                         </div>
		<div>
			<p>Add it on the first page:</p>
			<label class="radio-inline">
			<input type="radio" name="bestSeller" value='false' <%=car.bestSeller === 'false' ? 'checked' : ''%>>False</label>
			<label class="radio-inline">
			<input type="radio" name="bestSeller" value='true' <%=car.bestSeller === 'true' ? 'checked' : ''%>>True</label>
		</div>


		<% } else { %>
			
			<p id="token" hidden><%=token%></p>		

			<div class="form-group">
                            	<label for="style">Style:</label>
                                <select name="style" id="style" class="form-control" />
		<option selected>Pick-up</option>
		<option>Single</option>
		<option>Smart</option>
		<option>Double</option>
		<option>Standart</option>
					</select>
                       	</div>
			<div class="form-group">
                                    	<label for="type">Type:</label>
                                    	<select name="type" id="type" class="form-control" />
		<option selected>รุนรถ</option>
		<option>รถยนฅ์นั่งส่วนบุคคล</option>
		<option>รถยนฅ์เพื่อการพาณิซย์</option>
		<option>รถยนฅ์อเนกประสงค์</option>
					</select>
                         </div>
		<div>
			<p>Add it on the first page:</p>
			<label class="radio-inline">
			<input type="radio" name="bestSeller" value='false' checked>False</label>
			<label class="radio-inline">
			<input type="radio" name="bestSeller" value='true'>True</label>
		</div>
		<form id="eventForm" class="col-xs-8 col-sm-6 col-md-5" />
                                       	<label for="image" class="form-label">Picture:</label>
					<input class="form-control" type="file" id="image" name="image" />
					<p></p>
		
			<input type="submit" class="btn btn-primary" name="submit" value="Add-car" />
		</form>	

		<% } %>

            	<% if (editing) { %>
			
                 	<input type="hidden" value="<%=car._id%>" name="carId" />
                            	<%= console.log(car._id) %>
                        <button class="btn btn-primary " type="submit"><% if (editing && !errorMessage) { %>Update Car<% } %></button>
		
                <% } %>
            </form>
         </div>
<%- include('../includes/gridBottom.ejs') %>

		<script type="text/javascript">

			let key = ''
			let serie = document.getElementById('serie').textContent
			let serieDetails = document.getElementById('serieDetails').textContent
			let wheel = document.getElementById('wheel').textContent
			let engine = document.getElementById('engine').textContent
			let grade = document.getElementById('grade').textContent
			let price = document.getElementById('price').textContent
			let color = document.getElementById('color').textContent
			let details = document.getElementById('details').textContent
			let style = document.getElementById('style').textContent
			let type = document.getElementById('type').textContent
			
			let bestSel = document.getElementByName('bestSeller')
			let bestSeller = ''
			for (let i=0; i < bestSel.length; i++) {
				if(bestSel[i].checked) bestSeller = bestSel[i].value
			}

			const token = document.getElementById('token').textContent
		
			var form = document.getElementById('eventForm');
			form.addEventListener('submit', (event) => {
				event.preventDefault();
				const data = {
					token,
					section: 'car',
					picture: event.target[0].files[0].name
				}
			
				fetch('http://localhost:3050/admin/upload', {
					method: 'POST',
					mode: 'no-cors',
					body: JSON.stringify(data),
					headers: {
				'Content-Type': "application/x-www-form-urlencoded; charset=UTF-8"
					// 'Content-Type': 'application/json'
					}
				})
				.then(d => {				
// in order to access the data from a ReadableStream you need to call one of the conversion
					return d.json()
				})
				.then(d => {
					key = d.key
					fetch(d.url, {
						method: 'PUT',
						body: event.target[0].files[0],
						headers: {
						'Content-Type': "image/jpeg"
						}	
					})	
				})
				.then(d => {
					// picture url will be 
				const picUrl = `https://node-advance-course.s3-ap-southeast-1.amazonaws.com/${key}`
				console.log('after target s3: ', picUrl)
				
				// dataForDb should be pass as arg, and here we add the picUrl
				const dataForDb = {
					style,
					picUrl,
					token
				}
					
				return fetch('http://localhost:3050/admin/add-picsstyle', {
					method: 'POST',
					mode: 'no-cors',
					body: JSON.stringify(dataForDb),
					headers: {
				'Content-Type': "application/x-www-form-urlencoded; charset=UTF-8"
					// 'Content-Type': 'application/json'
					}

				})
				})
				.then(d => {
					if (d) {
		window.location.replace("http://localhost:3050/admin/picsstyle")
					}	
				})
				.catch(e => console.log(e))

			})

      		</script >


</body>
</html>
